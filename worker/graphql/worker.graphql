fragment FullJob on job {
    id
    workspace_id
    url
    file_upload {
        id
        base64
    }

    progress
    status

    name
    description
    path
    option_cut_start
    option_cut_end
    option_fade_in
    option_fade_out
}

mutation ClaimJob($myId: uuid!) {
    claim_job(args: { worker_id: $myId }) {
        ...FullJob
    }
}

mutation ClaimDeleteJob($myId: uuid!) {
    claim_delete_job(args: { worker_id: $myId }) {
        id
        single {
            dirent {
                id
            }
            provider_id
        }
    }
}

mutation UpdateJobProgress($jobId: uuid!, $progressStage: job_status_enum_enum!, $progress: numeric!) {
    update_job_by_pk(pk_columns: { id: $jobId }, _set: { status: $progressStage, progress: $progress }) {
        id
        progress
        status
        assigned_worker
    }
}

mutation CommitJob($jobId: uuid!, $entry: directory_entry_insert_input!, $single: single_insert_input!) {
    delete_job_by_pk(id: $jobId) {
        __typename
        id
        url
        name
    }
    insert_directory_entry_one(object: $entry) {
        __typename
        id
        name
    }
    insert_single_one(object: $single) {
        __typename
        id
    }
}

mutation CommitDeleteJob($jobId: uuid!, $fileId: uuid!) {
    delete_delete_job_by_pk(id: $jobId) {
        id
    }
    delete_directory_entry_by_pk(id: $fileId) {
        id
    }
}

mutation SetJobError($jobId: uuid!, $error: String!) {
    update_job_by_pk(pk_columns: { id: $jobId }, _set: { error: $error, status: error }) {
        ...FullJob
    }
}

mutation CheckIn($myId: uuid!, $checkinFrequency: Int!, $workerStart: timestamptz!) {
    insert_workers_one(
        object: { id: $myId, last_check_in: now, checkin_frequency_s: $checkinFrequency, worker_start: $workerStart }
        on_conflict: { constraint: workers_pkey, update_columns: [last_check_in, worker_start, last_check_in] }
    ) {
        id
        last_check_in
    }
}

query GetWorkerTimestamps {
    workers {
        id
        checkin_frequency_s
        worker_start
    }
}

mutation PruneWorkers {
    prune_workers {
        id
    }
}
